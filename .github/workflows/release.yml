name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Create distribution directory
        run: |
          mkdir -p ds-quick-strike
          cp module.json ds-quick-strike/
          cp -r scripts/ ds-quick-strike/

      - name: Create zip file
        run: |
          cd ds-quick-strike
          zip -r ../ds-quick-strike-${{ env.VERSION }}.zip .
          cd ..

      - name: Update module.json with version-specific URLs
        run: |
          # Update version
          sed -i 's/"version": "[^"]*"/"version": "${{ env.VERSION }}"/' ds-quick-strike/module.json
          # Update manifest URL
          sed -i 's|"manifest": ".*"|"manifest": "https://github.com/stgreenb/ds-quick-strike/releases/download/${{ env.VERSION }}/module.json"|' ds-quick-strike/module.json
          # Update download URL
          sed -i 's|"download": ".*"|"download": "https://github.com/stgreenb/ds-quick-strike/releases/download/${{ env.VERSION }}/ds-quick-strike-${{ env.VERSION }}.zip"|' ds-quick-strike/module.json
          # Show the result
          cat ds-quick-strike/module.json

      - name: Verify assets exist
        run: |
          echo "Checking for required assets:"
          ls -la ds-quick-strike/module.json
          ls -la ds-quick-strike-${{ env.VERSION }}.zip
          if [ ! -f "ds-quick-strike/module.json" ]; then
            echo "ERROR: module.json not found!"
            exit 1
          fi
          if [ ! -f "ds-quick-strike-${{ env.VERSION }}.zip" ]; then
            echo "ERROR: Zip file not found!"
            exit 1
          fi
          echo "All assets verified successfully"

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Draw Steel Quick Strike v${{ env.VERSION }}
          body: |
            ## Draw Steel Quick Strike v${{ env.VERSION }}

            A Foundry VTT module that enables collaborative damage application in the Draw Steel system through a secure GM relay mechanism.

            ### Features
            - Players can apply damage to NPC tokens they don't own
            - GM relay system with SocketLib
            - Private chat logging with undo functionality
            - Self-damage warnings
            - Accurate source attribution

            ### Requirements
            - SocketLib module
            - Foundry VTT v11+
            - Draw Steel system

            ### Installation
            1. In Foundry, go to **Add-on Modules** â†’ **Install Module**
            2. Enter this URL: `https://github.com/stgreenb/ds-quick-strike/releases/download/${{ env.VERSION }}/module.json`
            3. Click **Install**

            Or search for "Draw Steel Quick Strike" in the Foundry Module Browser.
          draft: false
          prerelease: false
          files: |
            ds-quick-strike/module.json
            ds-quick-strike-${{ env.VERSION }}.zip

      - name: Clean up
        run: |
          rm -rf ds-quick-strike
          rm -f ds-quick-strike-${{ env.VERSION }}.zip